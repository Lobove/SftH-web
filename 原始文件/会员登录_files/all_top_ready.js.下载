//手机端跳转
function browserRedirect() 
{
    var sUserAgent = navigator.userAgent.toLowerCase();
    //var bIsIpad = sUserAgent.match(/ipad/i) == "ipad";
    var bIsIphoneOs = sUserAgent.match(/iphone os/i) == "iphone os";
    var bIsMidp = sUserAgent.match(/midp/i) == "midp";
    var bIsUc7 = sUserAgent.match(/rv:1.2.3.4/i) == "rv:1.2.3.4";
    var bIsUc = sUserAgent.match(/ucweb/i) == "ucweb";
    var bIsAndroid = sUserAgent.match(/android/i) == "android";
    var bIsCE = sUserAgent.match(/windows ce/i) == "windows ce";
    var bIsWM = sUserAgent.match(/windows mobile/i) == "windows mobile";
    if ((bIsIphoneOs || bIsMidp || bIsUc7 || bIsUc || bIsAndroid || bIsCE || bIsWM) )
    {
        var purl = window.location.href;
        if(purl.indexOf('/detail/') != -1)
        { 
            //商品详情页
            var commoNo = $("#commoNo").val();
            var prodNo = $("#prodNo").val();
            if(commoNo != "undefined" && prodNo != "undefined")
            {
                window.location.href='http://m.purcotton.com/wap/detail/'+commoNo+'/'+prodNo+'.html';
            }
            else
            {
                var newurl = purl.replace('http://www.purcotton.com/detail/','');
                var urlarr = newurl.split('/');
                var urlarr1 = urlarr[1].replace('.html','');
                var urlarr2 = urlarr1.split('?');
                if(urlarr2[1])
                {
                    window.location.href='http://m.purcotton.com/mall/commodity/getCommodityDetail.ihtml?prodNo='+urlarr2[0]+'&'+urlarr2[1];
                }
                else
                {
                    window.location.href='http://m.purcotton.com/mall/commodity/getCommodityDetail.ihtml?prodNo='+urlarr2[0];
                }
            }
        }
        else if(purl.indexOf('www.purcotton.com') != -1)
        {
            if(typeof(tz) == "undefined")
            {
                var newurl = purl.replace('www.purcotton.com','m.purcotton.com');
                window.location.href = newurl;
            }
            else
            {
                var urlarr2 = purl.split('?');
                if(urlarr2[1])
                {
                    window.location.href=tz+'?'+urlarr2[1];
                }
            }
        }
    }
}
browserRedirect();

//得到订单数量
$(function() {

    $('.bt').click(function(){
          searchProd();
    });
    
    $(".btn-search").click(function(){
          searchProd();
    });
    
    $(".shopping-cart").click(function(){
        var url = MallPath + "/mall/cart/viewMayCart.ihtml";
        window.location.href = url;
    });
    
    $.getJSON(MallPath + "/mall/main/getCommonRequest.ihtml?timestamp=" + new Date().getTime(), function(json) {
        var num = json.catNum;
        if (num > 99) {
            $("#catNum").html('99+').addClass('cat-num-l');
        }else {
            $("#catNum").html(num).removeClass('cat-num-l');
        }
        
        var member = json.listData;
        var userInfo=json.userInfo;
        if(member!=""){ 
            var html="";
            html +='<li><a href="'+MallPath+'/mall/member/searchmember.ihtml">您好,'+member+'</a></li>';
            html +='<li class="i">|</li>';
            html +='<li><a href="javascript:void(0)" onclick="loginOut()" style="cursor:pointer">退出</a></li>';

            $('.top_member').html(html);
            
            // 显示上下午时间
            var now = new Date(),hour = now.getHours();
            var timeArea = "";
            if (hour < 6){
                timeArea = "凌晨";
            } else if (hour < 9){
                timeArea = "早上";
            } else if (hour < 12){
                timeArea = "上午";
            } else if (hour < 14){
                timeArea = "中午";
            } else if (hour < 17){
                timeArea = "下午";
            } else if (hour < 19){
                timeArea = "傍晚";
            } else if (hour < 22){
                timeArea = "晚上";
            } else {
                timeArea = "夜里";
            }
            
            var htmlNew = "";
            htmlNew += '<a href="'+MallPath+'/mall/member/searchmember.ihtml">尊敬的 ' + member + ' , ' + timeArea + '好！</a>';
            htmlNew += '<span>|</span>';
            htmlNew += '<a href="javascript:void(0)" onclick="loginOut()" style="cursor:pointer">退出</a>';
            $('#top_member_new').html(htmlNew);
         }
        
        if(userInfo){
            var nameLen=$("#name").length;
            var phoneLen=$("#phone").length;
            var emailLen=$("#email").length;
            if(nameLen>0&&phoneLen>0&&emailLen>0){
                $("#name").val(userInfo.loginName);
                $("#phone").val(userInfo.mobile);
                $("#email").val(userInfo.email);
            }
        }
        //pingyou 新版-->
        var pyName="";
        if(userInfo){
            pyName=userInfo.loginName;
        }
        (function(w,d,s,l,a){
            w._CommandName_=l;w[l]=w[l]||function(){(w[l].q=w[l].q||[]).push(arguments);
            w[l].track = function(){(w[l].q[w[l].q.length-1].t=[]).push(arguments)};return w[l]},w[l].a=a,w[l].l=1*new Date();
            var c = d.createElement(s);c.async=1;
            c.src='//fm.ipinyou.com/j/a.js';
            var h = d.getElementsByTagName(s)[0];h.parentNode.insertBefore(c, h);
        })(window,document,'script','py','LDs..Jn6TnonVYGKNTOhxcsD6jX');
        py('set','user',{
        'id':'',
        'name':pyName
        });
        py('event','viewPage');
        //pingyou 新版-->
    });
    /*if(null!=$('.hotwords')){
        var temp = '[{"name":"0-1岁宝宝秋冬服饰","value":"1111"},{"name":"1-3岁宝宝必备棉品","value":"222"}]';
        var result=eval("("+temp+")");
        var hostStr ="";
        if(null!=result&&""!=result){
            var url=MallPath+'/mall/CommodityList/searchCommodity.ihtml?queryWord='+result[0].name;
            hostStr = hostStr+"<a href='"+url+"'>"+result[0].name+"</a>";
            
            var url1=MallPath+'/mall/CommodityList/searchCommodity.ihtml?queryWord='+result[1].name;
            hostStr = hostStr+"<a href='"+url1+"'>"+result[1].name+"</a>";
        }
        $('.hotwords').append(hostStr);
    }*/
    $(".top-ew").attr("title","二维码");
    //加载网盟cookie 不包括商品详情页面
    var wmurl = window.location.href;
    if(wmurl.indexOf('detail') == -1){
        addLeaguememberCookieOther();
    }
    if(null!=$( "#searchText" )){
        var serchText= $( "#searchText" );
        /**判断搜索框是否包含autocomplete方法,该方法调用query-ui.js**/
        if(typeof serchText.autocomplete!='undefined'&serchText.autocomplete instanceof Function){
             $( "#searchText" ).autocomplete({
                  minLength: 1,//最少输入1个字符才执行
                  source: MallPath + "/mall/main/keyWords.ihtml",
                  select: function( event, ui ) { /**选中事件,自动调整到详情页**/
                       // event 是当前事件对象
                      // ui对象仅有一个item属性，它表示当前被选中的菜单项对应的数据源对象
                      // 该对象具有label和value属性，以及其它自定义(如果有的话)的属性
                      var value = ui.item.value;
                      var url = MallPath+'/mall/CommodityList/searchCommodity.ihtml?queryWord='+value;
                      window.location.href =url;
                  }
            });
        }
    }
    
    /** 展示扫描二维码 **/
    $(".show-code").click(function(){
        $(".code-wrap").removeClass("hide");
        $(".code-back").removeClass("hide");
        $(".form-wrap").addClass("hide");
        $(".code-tips").addClass("hide");
        $(".code-tip").addClass("hide");
    });
});

function getSessionId(){
       var c_name = 'JSESSIONID';
       if(document.cookie.length>0){
          c_start=document.cookie.indexOf(c_name + "=");
          if(c_start!=-1){ 
            c_start=c_start + c_name.length+1; 
            c_end=document.cookie.indexOf(";",c_start);
            if(c_end==-1) c_end=document.cookie.length;
            return unescape(document.cookie.substring(c_start,c_end));
          }
       } else return "0123456789";
      }
     

function keyCodeValidate(evt){ //当按回车触发该方法，像后台发出请求
     var currKey = 0;
     evt = evt ? evt : (window.event ? window.event : null);  //支持FF && IE
     currKey = evt.keyCode || evt.which || evt.charCode;
     if(currKey == 13){
          searchProd();
     }
}

function searchProd(){
   var queryWord = $('.txt').val();
    var salesTagNos = $.trim(queryWord); //验证不能输入空值
    if(""==salesTagNos){
        return ;
    }   
    //搜索长度，超过50个就自动截取
    if(salesTagNos.length>50) {
        salesTagNos= salesTagNos.substring(0,50);
    }
    //var url = MallPath+'/mall/CommodityList/searchCommodity.ihtml?queryWord='+salesTagNos;
    var url = MallPath+'/mall/CommodityList/searchCommodity.ihtml?queryWord='+salesTagNos;
    window.location.href =url;
}


var gettitle = document.title.split(",", 1);
//QQ空间
function shareQzone() {
    //window.open(
    //      'http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?desc='
    //              + encodeURIComponent(gettitle + ' '
    //                      + document.location.href), '_blank');
    var bit_code = null;
    var mask_div = null;
    var html = "";
    if(document.getElementById("bit-code")){
        bit_code = $$("bit-code");
        bit_code.show();
    }else{
        html += "<div id=\"bit-code\"><img src=\""+MallRes+"/base/images/U3BLNIQG8Lerweima.png\" /></div>";
    }
    if(document.getElementById("mask-div")){
        mask_div = $$("mask-div");
        mask_div.show();
    }else{
        html += "<div class=\"mask-div\" id=\"mask-div\"></div>";
    }
    $("body").append(html);
    bit_code = $$("bit-code");
    mask_div = $$("mask-div");
    bit_code.css({"width":100+"px",height:140+"px","position":"fixed","z-index":1999});
    checkPosition(bit_code, mask_div);
    window.onresize = function(){
        checkPosition(bit_code, mask_div);
    };
    
    mask_div.click(function(){
        bit_code.hide();
        mask_div.hide();
    });
}

//新浪
function shareSina() {
    window.open('http://v.t.sina.com.cn/share/share.php?title='
                    + encodeURIComponent(gettitle + ' ' + location.href)
                    + '&amp;url=' + encodeURIComponent(location.href)
                    + '&amp;rcontent=' + encodeURIComponent(gettitle),
                    '_blank',
                    'scrollbars=no,width=600,height=450,left=75,top=20,status=no,resizable=yes');
}

//腾讯微博
function shareTxweibo() {
    window.open('http://v.t.qq.com/share/share.php?url='
            + encodeURIComponent(gettitle + ' ' + document.location.href),
            '_blank');
}

//网页收藏
var www_zzjs_net = function (obj) {
//  var title = document.title;
//    var url = document.location.href;
//  
//    try {
//        window.external.addFavorite(url, title);
//    } catch(e) {
//        try {
//            window.sidebar.addPanel(title, url, "");
//        } catch(e) {
//            alert("抱歉，您所使用的浏览器无法完成此操作。\n\n加入收藏失败，请使用Ctrl+D进行添加");
//        }
//    }
    if (document.all){
        try{
            window.external.addFavorite(window.location.href,document.title);
        }catch(e){
            alert( "加入收藏失败，请使用Ctrl+D进行添加" );
        }
        
    }else if (window.sidebar){
        window.sidebar.addPanel(document.title, window.location.href, "");
     }else{
        alert( "加入收藏失败，请使用Ctrl+D进行添加" );
    }

};

function checkPosition(code, mask){
    var _w = document.documentElement.clientWidth,
        _h = document.documentElement.clientHeight;
    code.css({
        left : (_w - code.width()) / 2 + "px",
        top : (_h-code.height())/2>200 ? 200 : (_h-code.height())/2 + "px"
    });
    mask.css({
        width : _w + "px",
        height : _h + "px"
    });
};

function $$(id){
    return $(document.getElementById(id));
}

//打开聊天窗口
function openWinWebim(){
    var prodNo=$("input[name=prodNo]").val();
    var str="";
    if(prodNo){
        str="?prodNo="+prodNo;
    }
    window.open(MallPath+'/mall/webim/toWebim4Client.ihtml'+str,'webChat','height=605, width=905, top=100,left=300, toolbar=no, menubar=no, scrollbars=no, resizable=1,location=no, status=no');
}

//将网盟标识的写入cookie 不包括商品详情页
function addLeaguememberCookieOther(){
    var url = window.location.href;
    var index = url.indexOf("?");
    var arg = url.substring(index+1, url.length); 
    var argArr = new Array();
    if(url.indexOf("&") != -1){
        argArr = arg.split("&");
    }else{
        argArr[0] = arg;
    }
    
    var leaguemember_Id = '';
    for(var i = 0 ; i < argArr.length; i++){
        if(argArr[i].indexOf("leaguemember_Id") != -1 || argArr[i].indexOf("leaguemember_id") != -1){
            leaguemember_Id = argArr[i].substring(16,argArr[i].legnth);
            if(leaguemember_Id.indexOf("#") != -1){
                var arr = leaguemember_Id.split("#");
                leaguemember_Id = arr[0];
            }
        }
    }
    //alert(leaguemember_Id);
    if(leaguemember_Id != ''){
        //var cookieLeaguememberId = getCookie('leaguemember_Id'); //读取cookie
        //如果已经存在cookie名为leaguemember_Id，先删除cookie保证网盟用户的独立
        //if(typeof cookieLeaguememberId != undefined && cookieLeaguememberId != null){
        delCookieOther('leaguemember_Id'); //删除cookie
        //}
        //setCookieOther("leaguemember_Id",leaguemember_Id);//添加cookie
        var exp = new Date();
        exp.setTime(exp.getTime()+30*24*3600*1000);//30天
        document.cookie = 'leaguemember_Id' + "="+ escape (leaguemember_Id) + ";expires=" + exp.toGMTString() + ";path=/";
    }
}

function setCookieOther(name,value){//两个参数，一个是cookie的名子，一个是值 
    //var Days = 30; //此 cookie 将被保存 30 天
    var exp = new Date();    //new Date("December 31, 9998");
    exp.setTime(exp.getTime() + 6*60*60*1000);//保存6个小时
    document.cookie = name + "="+ escape (value) + ";expires=" + exp.toGMTString() + ";path=/";
}
function getCookieOther(name){//取cookies函数       
   var arr = document.cookie.match(new RegExp("(^| )"+name+"=([^;]*)(;|$)"));
   if(arr != null) return unescape(arr[2]); return null;
}
function delCookieOther(name){//删除cookie
    var exp = new Date();
    exp.setTime(exp.getTime() - 1);
    var cval=getCookieOther(name);
    if(cval!=null) document.cookie= name + "="+cval+";expires="+exp.toGMTString();
}

/**在登入页面跳转，登入成功后，直接加载到当前页面*/
function loginMember(){
    var pathName = window.location.pathname; 
    var searchName = window.location.search;
    
    if(undefined != debug && debug == "0"){ //0是访问动态页，1访问静态页
        pathName =  pathName.substring(1); //去除项目名
        pathName  = pathName.substring(pathName.indexOf("/"));
    }
    var url = pathName+""+searchName;
    window.location.href = MallPath+"/mall/memberLogin/toLogin.ihtml?urlPath="+url;
}

/**用户退出，退出后登录返回到退出前页面**/
function loginOut(){
    var pathName = window.location.pathname; 
    var searchName = window.location.search;
    
    if(undefined != debug && debug == "0"){ //0是访问动态页，1访问静态页
        pathName =  pathName.substring(1); //去除项目名
        pathName  = pathName.substring(pathName.indexOf("/"));
    }
    var url = pathName+""+searchName;
    window.location.href = MallPath+"/mall/memberLogin/loginOut.ihtml?urlPath="+url;
}

/** PC改版使用 Begin **/

/** 登录页面切换到注册页面 **/
function changeToRegister(){
    window.location.href = MallPath + "/mall/memberLogin/toRegister.ihtml";
}

/** 注册页面切换到登录页面 **/
function changeToLogin(){
    window.location.href = MallPath + "/mall/memberLogin/toLogin.ihtml";
}

/** 从扫码界面返回 **/
function goBack(){
    $(".code-back").addClass("hide");
    $(".code-wrap").addClass("hide");
    $(".form-wrap").removeClass("hide");
    $(".code-tips").removeClass("hide");
    $(".code-tip").removeClass("hide");
}

/**在登入页面跳转，登入成功后，直接加载到当前页面*/
function loginMemberNewPC(){
    var pathName = window.location.pathname; 
    var searchName = window.location.search;
    
    /** if(undefined != debug && debug == "0"){ //0是访问动态页，1访问静态页
        pathName =  pathName.substring(1); //去除项目名
        pathName  = pathName.substring(pathName.indexOf("/"));
    } **/
    var url = pathName + "" + searchName;
    window.location.href = MallPath + "/mall/memberLogin/toLogin.ihtml?urlPath=" + url;
}
/** PC改版使用 End **/