jQuery(document).ready(function($) {
	// 0注册，1登录
	// $('.login-popup .pop-item').hide().eq(0).show();

	// 去注册
	$('.pop-reg').click(function () {
		$('.login-popup .pop-item').hide().eq(0).show();
	});
	// 去登录
	$('.pop-log').click(function () {
		$('.login-popup .pop-item').hide().eq(1).show();
	});

	// 搜索商品按钮
	$(".btn-search").click(function(){
		if($.trim($('.txt').val()) == ''){
			layer.tips('请输入搜索文字哦~', '.search-text', {
			  tips: [1, '#ff7878'] //还可配置颜色
			});
		}else {
			searchProd();
		}
	});
});

var interface_path = 'http://www.purcotton.com/mall/memberLogin/';

// 快速登录
function loginShop() {

	if ($.trim($("#loginName").val()) == "" || $.trim($("#loginName").val()) == null) 
	{
		$("#warn2").html("请输入邮箱/用户名/已验证手机");
		$("#warnMsgLog").html("请输入登录名！");
		$("#warn2").show();
		$("#loginName").focus();
		
		return false;
	} 
	
	if ($.trim($("#loginPassword").val()) == null || $.trim($("#loginPassword").val()) == "") 
	{
		$("#warn2").html("请输入密码");
		$("#warnMsgLog").html("请输入密码！");
		$("#warn2").show();
		$("#loginPassword").focus();
		return false;
	}
	
	if ($.trim($("#imgCode2").val()) == null || $.trim($("#imgCode2").val()) == "") 
	{
		$("#warn2").html("请输入图形验证码");
		$("#warnMsgLog").html("请输入图形验证码！");
		$("#warn2").show();
		$("#imgCode2").focus();
		return false;
	}

	/*if ($("#zdt").attr("checked") == "checked") 
	{
		setCookie("userName", $.trim($("#loginName").val()), 24, "/");
		setCookie("password", $.trim($("#loginPassword").val()), 24, "/");
	} 
	else 
	{
		deleteCookie("userName", "/");
		deleteCookie("password", "/");
	}*/
	//var locationUrl = window.location.href;
	//loginForm.submit();
	
	var loginName  = $("#loginName").val();
	var password =  $("#loginPassword").val();
	var imgCode2 = $("#imgCode2").val();
	var params = "loginName="+loginName + "&loginPassword="+password+"&imgCode2="+imgCode2;
	
	$.ajax({
		type: "POST",
		url: MallPath+"/mall/memberLogin/fastLogin.ihtml",
		data: params,
		cache: false,                   
		success : function(data) 
		{
			var result=eval("("+data+")");  
			if(result.success)
			{ 
				$("#warn2").hide();
				$("#warnMsgLog").hide();
				$('.login-register').hide();
				window.location.reload();
			}
			else
			{
				$("#warn2").html(result.message);
				$("#warnMsgLog").html(result.message);
				$("#warn2").show();
				$("#loginName").focus();                            
			}
		}
	});
}

//加载验证码（登录）
function reloadLog() {
	var cpt = document.getElementById('vpicLog');
	var src = cpt.src;
	cpt.src = src + '?' + Math.random();
}

//加载验证码（注册）
function reloadReg() {
	var cpt = document.getElementById('vpicReg');
	var src = cpt.src;
	cpt.src = src + '?' + Math.random();

}

//注册提交
function gotoRegisterForNewPC()
{
	var mobile = $("#telephone").val();
	if (mobile.length == 0)
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("手机号码不能为空");
		return false;
	}
	
	var password = $("#password").val();
	if (password.length == 0)
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("密码不能为空");
		return false;
	}
	
	var rePassword = $("#re_password").val();
	if (rePassword.length == 0) 
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("确认密码不可以为空!");
		return false;
	}
	
	var imageCode = $("#imageCode").val();
	if (imageCode.length == 0) 
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("图形验证码不可以为空!");
		return false;
	}
	
	var validateCode = $("#validateCode").val();
	if (validateCode.length == 0) 
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("短信验证码不可以为空!");
		return false;
	}
	
	var sTel = checkmobileForNewPC();
	var stelcode = onTelCodeForNewPC();
	var vimgcode = onMsgCheckForNewPC();

	//pingyou注册统计
	var _orderno = document.getElementById("telephone").value;
	juxiaoTongji(_orderno);

	if (sTel == true && vimgcode == true && stelcode == true ) 
	{
		document.getElementById("submitBtn").innerHTML = "<span class='button9'><b>提交中...</b></span>";
		document.getElementById("register").submit();
		return true;
	}
}

//去siebel校验手机号是否注册，用于正常流程注册
function checkmobileForNewPC()
{
	var mobile = $("#telephone").val();
	var myreg = /^0?(13|15|17|18|14)[0-9]{9}$/;
	if (mobile.length == 0)
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("手机号码不能为空");
		return false;
	} 
	else if (mobile.length != 11)
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("请输入11位有效的手机号码");
		return false;
	} 
	else if (!myreg.test(mobile))
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("请输入有效手机号");
		return false;
	} 
	else
	{
		var flag = false;
		$.ajax({
			type : "POST",
			url : interface_path + "checkTelephone.ihtml?",
			data : {
				"mobile" : $.trim($("#telephone").val())
			},
			async : false,
			dataType : "json",
			success : function(data) 
			{
				if (data == "1") 
				{
					if($("#warnMsgReg").hasClass("green"))
					{
						$("#warnMsgReg").removeClass("green").addClass("red");
					}
					$("#warnMsgReg").html('该手机号已注册，请点击下方按钮前往登录');
					flag = false;
				}  
				else 
				{
					$("#warnMsgReg").removeClass("red").addClass("green");
					$("#warnMsgReg").html("该手机号可以使用");
					flag = true;
				}
			}
		});
		return flag;
	}
}

// 短信验证码校验
function onTelCodeForNewPC()
{
	if ($.trim($("#validateCode").val()) == "" || $.trim($("#validateCode").val()) == null) 
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("手机验证码不能为空");
		return false;
	} 
	else 
	{
		var flag = true;
		$.ajax({
			type : "POST",
			url : interface_path + "checkIdentifyCode.ihtml",
			data : {
				"loginName": $.trim($("#telephone").val()),
				"code" : $.trim($("#validateCode").val())
			},
			async : false,
			dataType : "json",
			success : function(data) 
			{
				if (data == "0") 
				{
					if($("#warnMsgReg").hasClass("green"))
					{
						$("#warnMsgReg").removeClass("green").addClass("red");
					}
					$("#warnMsgReg").html("手机验证码错误");
					flag = false;
				} 
				else 
				{
					$("#warnMsgReg").removeClass("red").addClass("green");
					$("#warnMsgReg").html("手机验证码正确");
					return true;
				}
			}
		});
		return flag;
	}
}

//图像验证码校验
function onMsgCheckForNewPC()
{
	if ($.trim($("#imageCode").val()) == "" || $.trim($("#imageCode").val()) == null)
	{
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("验证码不可以为空");
		return false;
	}
	else
	{
		var flag = true;
		$.ajax({
			type : "POST",
			url : interface_path + "checkVerifyMsg.ihtml?random=" + Math.random(),
			data : {
				"validation" : $.trim($("#imageCode").val())
			},
			async : false,
			dataType : "json",
			success : function(data) 
			{
				if (data == "0") 
				{
					if($("#warnMsgReg").hasClass("green"))
					{
						$("#warnMsgReg").removeClass("green").addClass("red");
					}
					$("#warnMsgReg").html("验证码错误");
					flag = false;
				} 
				else 
				{
					$("#warnMsgReg").removeClass("red").addClass("green");
					$("#warnMsgReg").html("验证码校验成功");
					return true;
				}
			}
		});
		return flag;
	}
}

function onPwdCheckForNewPC() {
	var password = $.trim($("#password").val());
	if (f_haveBank($("#password").val())) {
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("密码不能包含空格组成");
		return false;
	}
	var patrn = /^(\w){8,20}$/;
	if (!patrn.exec(password)) {
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("密码必须为8-20个字母、数字、下划线组成");
		return false;
	} else {
		$("#warnMsg").html("");
		return true;
	}
}

function onPwd2CHeckForNewPC() {
	if ($.trim($("#re_password").val()) == "" || $.trim($("#re_password").val()) == null) {
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("确认密码不可以为空!");
		return false;
	} else if ($.trim($("#password").val()) != $.trim($("#re_password").val())) {
		if($("#warnMsgReg").hasClass("green"))
		{
			$("#warnMsgReg").removeClass("green").addClass("red");
		}
		$("#warnMsgReg").html("两次密码输入不一致!");
		return false;
	} else {
		$("#warnMsgReg").html("");
		return true;
	}
}

//获取短信验证码,普通流程注册
function getCodeForNewPC() {
	// 手机号验证
	var vcode = checkmobileForNewPC();
	var vimgcode = onMsgCheckForNewPC();
	if (vcode && vimgcode) {
		timezy(document.getElementById("btn"), document.getElementById("telephone"));
		$("#btn").css("cursor", 'default');
		$.ajax({
			type : "POST",
			url : MallPath+"/mall/memberLogin/sendPhoneSMSCode.ihtml?random=" + Math.random(),
			data : {
				"telephone" : $.trim($("#telephone").val()),
				"purpose": 'Register',
				"imageCode": $.trim($("#imageCode").val())
			},
			async : true,
			dataType : "json",
			success : function(result)
			{
				if(result.success == true)
				{
					$("#warnMsgReg").removeClass("red").addClass("green");
					$("#warnMsgReg").html(result.data);
				}
				else
				{
					$("#warnMsgReg").html(result.data);
				}
			}
		});
	}
	else {
		layer.msg('请输入有效手机号或验证码！', function(){});
	}
}

function f_haveBank(msg) {
	for ( var idx = 0; idx < msg.length; idx++) {
		if (msg.substr(idx, 1) == " ") {
			return true;
		}
	}
	return false;
}

// 120秒后获取验证码
var wait = 120;

function time(o) {

	if (wait == 0) {
		o.removeAttribute("disabled");
		$("#btn").css({
			"width" : "90",
			"border" : "1px white solid"
		});
		o.value = "重新获取验证码";
		$("#btn").css("cursor", "pointer");
		wait = 120;
	} else {
		$(document).ready(function() {
			$("#btn").css({
				"width" : "100",
				"height" : "25px",
				"border" : "1px white solid"
			});
		});

		o.setAttribute("disabled", true);
		o.value = "" + wait + "s后重新获取";
		wait--;
		setTimeout(function() {
			time(o);
		}, 1000);
	}
}

function time1(o, b) {
	if (wait == 0) {
		b.removeAttribute("readOnly");
		b.style.backgroundColor = "white";
		o.removeAttribute("disabled");
		$("#btn").css({
			"width" : "90",
			"border" : "1px white solid"
		});
		o.value = "重新获取验证码";
		$("#btn").css("cursor", "pointer");
		wait = 120;
	} else {
		$(document).ready(function() {
			$("#btn").css({
				"width" : "100",
				"height" : "25px",
				"border" : "1px white solid"
			});
		});

		b.setAttribute("readOnly", true);
		b.style.backgroundColor = "#adadad";
		o.setAttribute("disabled", true);
		o.value = "" + wait + "s后重新获取";
		wait--;
		setTimeout(function() {
			time1(o, b);

		}, 1000);
	}
}

function timezy(o, b) {
	if (wait == 0) {
		b.removeAttribute("readOnly");
		b.style.backgroundColor = "white";
		o.removeAttribute("disabled");
		$("#btn").css({
			"color" : "#00937f",
			"border" : "1px solid #00937f",
			"background": "#fff"
		});
		o.value = "重新获取验证码";
		$('#imageCode').value = "";
		$("#btn").css("cursor", "pointer");
		wait = 120;
	} else {
		$(document).ready(function() {
			$("#btn").css({
				"color": "#999",
				"background": "#eee"
			});
		});

		b.setAttribute("readOnly", true);
		o.setAttribute("disabled", true);
		o.value = "" + wait + "s后重新获取";
		wait--;
		setTimeout(function() {
			timezy(o, b);

		}, 1000);
	}
}

// enter
document.onkeydown = function(e) {
	var ev = e || window.event;
	if (ev.keyCode == 13) {
		var $pop = $('.login-popup .pop-item');

		var dis_reg = $pop.eq(0).css('display');
		var dis_log = $pop.eq(1).css('display');
		
		if (!$('.login-popup').is(':hidden')) {
			if (dis_reg == 'block' && dis_log == 'none') {
				gotoRegisterForNewPC();
			}else if (dis_log == 'block' && dis_reg == 'none') {
				loginShop();
			}
		}else {
			if ($('.search-text').is(':focus')) {
				if($.trim($('.txt').val()) == ''){
					layer.tips('请输入搜索文字哦~', '.search-text', {
					  tips: [1, '#ff7878']
					});
				}else {
					searchProd();
				}
			}
		}
	}
};